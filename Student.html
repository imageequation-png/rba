<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CatalyseR – Raw Brain Analysis (Student)</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root{--bg:#f3f7f5;--g1:#16a34a;--g2:#22c55e;--muted:#6b7280;--card:#fff;--text:#0f172a}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);font-family:"Inter",sans-serif;color:var(--text);display:flex;align-items:center;justify-content:center;padding:20px}
.container{width:100%;max-width:920px;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 28px 60px rgba(2,6,23,0.06);position:relative}
.header{text-align:center;margin-bottom:8px}
.logo{height:28px;object-fit:contain;display:block;margin:0 auto}
.title{font-family:"Poppins",sans-serif;font-weight:600;font-size:22px;color:var(--g1);margin-top:6px}

/* intro card */
.intro-wrapper{display:flex;justify-content:center;align-items:center;min-height:38vh}
.card{width:auto;max-width:360px;padding:16px;border-radius:12px;background:linear-gradient(180deg,#fff,#f8fffb);box-shadow:0 8px 30px rgba(2,6,23,0.04);border:1px solid rgba(16,185,129,0.06)}
.field{margin-bottom:12px}
.label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
.input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6eef8;font-size:14px;background:#fff}
.small-btn{display:inline-block;padding:8px 12px;border-radius:999px;border:2px solid var(--g1);background:transparent;color:var(--g1);font-weight:600;font-size:13px;cursor:pointer;min-width:90px;text-align:center}

/* test UI */
.test-header{display:flex;justify-content:center;align-items:center;padding:6px 0}
.testlogo{height:28px}
.controls{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.qcount{font-size:16px;font-weight:600;color:var(--g1);margin-bottom:8px}
.progress{height:8px;background:#e9f7ee;border-radius:999px;margin:10px 0;overflow:hidden}
.pfill{height:8px;width:0%;background:linear-gradient(90deg,var(--g1),var(--g2));border-radius:999px}
.qcard{background:#fff;padding:16px;border-radius:12px;border:1px solid #eef6ef;box-shadow:0 12px 28px rgba(2,6,23,0.04);margin-top:8px}
.qtext{font-size:16px;line-height:1.6;font-weight:500;margin-bottom:12px}
.opt{width:100%;text-align:left;padding:10px 12px;margin-bottom:8px;border-radius:10px;border:1px solid #e6eef8;background:#fff;cursor:pointer;font-size:14px}
.opt:hover{background:#f0fdf4}

/* timer */
.timer-wrap{display:flex;flex-direction:column;align-items:center;gap:6px}
.timer-num{font-family:"Poppins",sans-serif;font-weight:700;font-size:18px;color:#065f46}

/* report */
.report-title{font-family:"Poppins",sans-serif;color:var(--g1);font-weight:600;text-align:center;margin-bottom:8px}
.rmeta{font-size:13px;color:#374151;margin-bottom:8px}
.answers-list .rq{font-weight:600;font-size:13px;margin-top:8px}
.answers-list .ra{margin-left:10px;font-size:13px}
.info{font-size:14px;color:#374151;margin-top:10px;text-align:center}

/* modal */
.modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:92%;max-width:720px;background:#fff;border-radius:12px;display:flex;overflow:hidden}
.modal-hero{flex:1;padding:18px;background:linear-gradient(180deg,#dcfce7,#bbf7d0);color:#052e16;display:flex;flex-direction:column;justify-content:space-between}
.modal-main{flex:1.1;padding:18px}
.lang-btn{padding:6px 8px;border-radius:999px;border:1px solid #d1d5db;background:#f9fafb;font-size:12px;cursor:pointer}
.lang-active{background:var(--g1);color:#fff;border-color:var(--g1)}
.modal-start{margin-top:12px;padding:10px 12px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--g1),var(--g2));color:#fff;font-weight:600;cursor:pointer}
.warn{color:#b91c1c;text-align:center;display:none;margin-top:8px;font-size:13px}

/* responsive */
@media (max-width:420px){.card{padding:14px}.title{font-size:20px}.qtext{font-size:15px}}
</style>
</head>
<body>
<div class="container" role="main">
  <div class="header">
    <img src="catalyser.jpg" alt="CatalyseR" class="logo" />
    <div class="title">Raw Brain Analysis</div>
  </div>

  <!-- INTRO -->
  <div id="page-intro" class="page active">
    <div class="intro-wrapper">
      <div class="card" role="form">
        <div class="field">
          <label class="label" for="name">Student Name *</label>
          <input id="name" class="input" type="text" placeholder="Full name" />
        </div>
        <div class="field">
          <label class="label" for="class">Class *</label>
          <select id="class" class="input">
            <option value="">Select class</option>
            <option value="6">6th</option>
            <option value="7">7th</option>
            <option value="8">8th</option>
            <option value="9">9th</option>
            <option value="10">10th</option>
            <option value="11">11th</option>
            <option value="12">12th</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="school">School *</label>
          <input id="school" class="input" type="text" placeholder="School name" />
        </div>

        <div style="display:flex;justify-content:center;margin-top:6px">
          <button id="startBtn" class="small-btn">Start</button>
        </div>
        <div id="warn" class="warn">Please fill Name (letters only), Class and School before starting.</div>
      </div>
    </div>
  </div>

  <!-- TEST PAGE -->
  <div id="page-test" class="page">
    <div class="test-header">
      <img src="catalyser.jpg" alt="CatalyseR" class="testlogo" />
    </div>

    <div class="controls" style="margin-top:8px">
      <div class="left">
        <div id="qcount" class="qcount">Question 1 of 20</div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div id="langToggle" class="lang-toggle" aria-hidden="false"></div>

        <div class="timer-wrap" aria-live="polite">
          <svg id="timerSvg" width="64" height="64" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="44" stroke="#e9f7ee" stroke-width="12" fill="none"></circle>
            <circle id="timerArc" cx="50" cy="50" r="44" stroke="#16a34a" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="276.46" stroke-dashoffset="0"></circle>
          </svg>
          <div id="timerNum" class="timer-num" style="margin-top:4px">40</div>
        </div>
      </div>
    </div>

    <div class="progress"><div id="pfill" class="pfill"></div></div>

    <div class="qcard" id="qcard">
      <div id="qtext" class="qtext">Loading...</div>
      <div id="options"></div>
    </div>
  </div>

  <!-- REPORT PAGE (student only) -->
  <div id="page-report" class="page">
    <div class="report-title">Student Report – Raw Brain Analysis</div>
    <div id="rmeta" class="rmeta"></div>
    <div id="answers" class="answers-list"></div>
    <div id="info" class="info">Your responses have been recorded. A confidential report has been generated for counsellors.</div>
  </div>

</div>

<!-- modal -->
<div id="modal" class="modal-overlay" aria-hidden="true">
  <div class="modal">
    <div class="modal-hero">
      <div>
        <div style="font-size:20px;font-weight:700">Welcome to CatalyseR</div>
        <div style="margin-top:8px">This short exercise helps us understand how the student thinks, reacts and plans. Answer honestly.</div>
      </div>
      <div style="font-size:12px;opacity:0.95">Sit comfortably and read every question calmly.</div>
    </div>
    <div class="modal-main">
      <h3 style="color:var(--g1);margin:0 0 8px 0">Instructions</h3>
      <ul style="margin:0 0 8px 18px;color:#374151">
        <li>Each question has <strong>40 seconds</strong>. If time runs out question is recorded as not answered.</li>
        <li>Choose the option that matches your natural behaviour.</li>
        <li>Once you tap an option it is locked.</li>
      </ul>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <div style="font-size:13px;color:#374151">Language:</div>
        <button class="lang-btn lang-btn-modal lang-active" data-lang="EN">EN</button>
        <button class="lang-btn lang-btn-modal" data-lang="HI">हि</button>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="closeModal" class="small-btn" type="button">Close</button>
        <button id="beginBtn" class="modal-start" type="button">Begin Test</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- html2canvas & jspdf for admin PDF generation (used in admin page) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ---------------------------
   Firebase config (you provided)
   --------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAwHjxmW-blPOPksYRxulytL9yIHt2RHx0",
  authDomain: "catalyser-rba.firebaseapp.com",
  databaseURL: "https://catalyser-rba-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "catalyser-rba",
  storageBucket: "catalyser-rba.firebasestorage.app",
  messagingSenderId: "582692301116",
  appId: "1:582692301116:web:5dbeddb1b086007be01639",
};

/* Initialize Firebase */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------------------
   App state
   --------------------------- */
let current = 0;
let timeLeft = 40;
let timerInterval = null;
let answers = [];
let currentLanguage = "EN";
let modalSelectedLanguage = "EN";

/* DOM refs */
const pageIntro = document.getElementById("page-intro");
const pageTest = document.getElementById("page-test");
const pageReport = document.getElementById("page-report");
const startBtn = document.getElementById("startBtn");
const warn = document.getElementById("warn");
const modal = document.getElementById("modal");
const beginBtn = document.getElementById("beginBtn");
const closeModal = document.getElementById("closeModal");
const modalLangBtns = document.querySelectorAll(".lang-btn-modal");
const langToggle = document.getElementById("langToggle");

const qcount = document.getElementById("qcount");
const qtext = document.getElementById("qtext");
const optionsDiv = document.getElementById("options");
const pfill = document.getElementById("pfill");
const timerNum = document.getElementById("timerNum");
const timerArc = document.getElementById("timerArc");
const rmeta = document.getElementById("rmeta");
const answersDiv = document.getElementById("answers");
const info = document.getElementById("info");

/* --------- QUESTIONS (English) ---------- */
/* (Same questions as you provided earlier) */
const questionsEN = [
  {id:1, text:["When you complete something important — whether it’s homework, a class activity, or helping at home —","what thoughts naturally run in your mind afterwards?"], options:["I feel a strong sense of achievement and confidence.","I feel happy for some time and then move on.","I feel normal, nothing special.","I don’t think much about it; it feels routine."]},
  {id:2, text:["Imagine a day where everything goes well — good classes, supportive teachers, no stress —","how do you carry that positivity forward when you return home?"], options:["I stay cheerful and share my day with family.","I stay in a good mood but don't talk much about it.","I feel okay but behave like any normal day.","I don't feel much difference in how I behave."]},
  {id:3, text:["When a teacher appreciates you in front of the class for genuine effort,","how does that appreciation affect your confidence for the rest of the day?"], options:["I feel highly motivated to perform even better.","I feel happy but also a little shy.","I feel slightly embarrassed and want the attention to reduce.","I think it was just luck and not fully deserved."]},
  {id:4, text:["Think of a moment when you helped someone without being asked — friend, classmate, sibling or stranger —","how do you feel immediately after that act?"], options:["I feel responsible and proud.","I feel good and internally satisfied.","I feel normal; nothing special.","I feel anyone would have done the same."]},
  {id:5, text:["On an important day like a test, event or competition,","what is your natural mindset the moment you wake up?"], options:["Focused and mentally preparing for the day.","A mix of excitement and nervousness.","Normal; I don’t think too much about it.","Pressured and wanting the day to pass."]},
  {id:6, text:["You sit to study with good intention, but your phone keeps buzzing nearby —","how do you usually handle this distraction?"], options:["I keep the phone away or silent to stay focused.","I try ignoring it but sometimes check after a while.","I check the phone repeatedly while studying.","I start using the phone and lose track of studying."]},
  {id:7, text:["You plan your day or make a timetable but end up following only half of it —","how do you talk to yourself about it in the evening?"], options:["I motivate myself to do better tomorrow.","I accept it and move on.","I feel routines are difficult for me to follow.","I feel planning is useless and avoid it next time."]},
  {id:8, text:["You suddenly get one free hour with no work or pressure —","how do you naturally choose to spend that hour?"], options:["Finish something useful or pending.","Spend time on a hobby or interest.","Relax or do nothing specific.","Scroll mobile or use social media."]},
  {id:9, text:["You didn’t clearly understand a topic in school even though others did —","what is your next step after school?"], options:["Ask the teacher again during doubt time.","Search or watch videos to understand it.","Ask a friend to explain it.","Leave it for later."]},
  {id:10, text:["Whenever you have to learn something new — skill, chapter or concept —","what is your natural starting approach?"], options:["Break it into small steps and follow them.","Observe someone doing it first.","Start trying directly and learn by doing.","Avoid it if it seems unfamiliar."]},
  {id:11, text:["You see a student has fallen or needs help and a group gathers —","what is your natural reaction in such moments?"], options:["Go forward and help in some way.","Inform a teacher or adult quickly.","Watch from a distance.","Walk away quietly."]},
  {id:12, text:["You are given ₹500 to buy something required for a small task or event —","how do you handle this responsibility?"], options:["Compare options and buy smartly.","Buy something quickly without much comparison.","Ask someone for suggestions before buying.","Feel nervous and prefer someone else handles it."]},
  {id:13, text:["During a group project,","which role do you naturally take without being asked?"], options:["Planner who organizes work.","Idea person who suggests creative inputs.","Doer who executes tasks given.","Quiet follower who lets others decide."]},
  {id:14, text:["Your friend confidently explains something but you realize a key part is incorrect —","how do you respond?"], options:["Correct them politely at the right moment.","Guide them indirectly through questions.","Ignore and avoid interfering.","Agree or stay silent to avoid conflict."]},
  {id:15, text:["A gadget at home stops working — remote, toy or appliance —","what is your typical curiosity or reaction?"], options:["Try to understand what went wrong.","Press buttons or check basic things.","Ask someone else to fix it.","Ignore it completely."]},
  {id:16, text:["You are given a mystery challenge — clues, puzzle or detective-type task —","how do you usually feel entering such challenges?"], options:["Excited and want to solve it fully.","Curious and willing to try.","Nervous I may not solve it.","Avoid such tasks."]},
  {id:17, text:["To memorize 10 points for a presentation tomorrow —","which method do you naturally use first?"], options:["Make patterns or tricks.","Repeat them again and again.","Write them multiple times.","Delay and manage at last moment."]},
  {id:18, text:["Maths questions with multiple steps or tricky twists require patience —","what is your first natural reaction when such a question appears?"], options:["I want to try and see how far I can solve.","I try but only for some time.","I leave it for later.","I skip such questions whenever possible."]},
  {id:19, text:["Imagine yourself 8–10 years from now, with studies complete and career started —","which future picture feels most exciting or natural to you?"], options:["Working in a high-paying technical job after clearing IIT or top engineering exam.","Running a clinic or working in the medical / healthcare field.","Working in business/management after MBA or leadership program.","Doing something creative or unique beyond traditional career paths."]},
  {id:20, text:["Your school gives one extra hour daily for any activity —","which type of work would you most naturally choose?"], options:["Solve challenging questions or puzzles.","Do experiments or practical science tasks.","Plan or manage real-life tasks/events.","Do creative or design-based work."]}
];

/* -- helper: choose language set (HI not included for brevity; you can paste your Hindi array if you want it) */
function getQuestions(){ return questionsEN; }

/* ----- UI init ----- */
function showPage(el){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  el.classList.add("active");
}

/* language toggles (top) */
function buildLangToggle(){
  langToggle.innerHTML="";
  const en = document.createElement("button"); en.className="lang-btn"; en.textContent="EN"; en.dataset.lang="EN";
  const hi = document.createElement("button"); hi.className="lang-btn"; hi.textContent="हि"; hi.dataset.lang="HI";
  langToggle.appendChild(en); langToggle.appendChild(hi);
  [en,hi].forEach(b=>b.addEventListener("click",()=>{
    currentLanguage=b.dataset.lang;
    [en,hi].forEach(x=>x.classList.toggle("lang-active", x.dataset.lang===currentLanguage));
    if (pageTest.classList.contains("active")) loadQuestion();
  }));
  en.classList.add("lang-active");
}
buildLangToggle();

/* modal language */
modalLangBtns.forEach(b=>b.addEventListener("click", ()=>{
  modalLangBtns.forEach(x=>x.classList.remove("lang-active"));
  b.classList.add("lang-active");
  modalSelectedLanguage = b.dataset.lang;
}));

/* start validation */
startBtn.addEventListener("click", ()=>{
  const name = document.getElementById("name").value.trim();
  const cls = document.getElementById("class").value.trim();
  const school = document.getElementById("school").value.trim();
  const nameValid = /^[A-Za-z\s]+$/.test(name);
  if (!name || !nameValid || !cls || !school) {
    warn.style.display="block";
    return;
  }
  warn.style.display="none";
  // show modal
  modal.style.display="flex"; modal.setAttribute("aria-hidden","false");
});
closeModal.addEventListener("click", ()=>{ modal.style.display="none"; modal.setAttribute("aria-hidden","true"); });

/* begin test */
beginBtn.addEventListener("click", ()=>{
  currentLanguage = modalSelectedLanguage;
  // set header language buttons active
  document.querySelectorAll("#langToggle .lang-btn").forEach(b=>b.classList.toggle("lang-active", b.dataset.lang===currentLanguage));
  modal.style.display="none"; modal.setAttribute("aria-hidden","true");
  current = 0; timeLeft = 40; answers = [];
  showPage(pageTest);
  loadQuestion();
  startTimer();
});

/* load question */
function loadQuestion(){
  const qs = getQuestions();
  const q = qs[current];
  const total = qs.length;
  qtext.innerHTML = q.text.join(" ");
  qcount.textContent = `Question ${current+1} of ${total}`;
  pfill.style.width = ((current)/total*100) + "%";
  optionsDiv.innerHTML = "";
  q.options.forEach((opt, idx)=>{
    const b = document.createElement("button"); b.className="opt"; b.textContent=opt;
    b.addEventListener("click", ()=> selectOption(idx));
    optionsDiv.appendChild(b);
  });
  updateTimerUI();
}

/* timer (circular) */
const CIRC = 2 * Math.PI * 44;
timerArc.setAttribute("stroke-dasharray", CIRC.toFixed(2));
function startTimer(){
  clearInterval(timerInterval);
  timerInterval = setInterval(()=> {
    if (timeLeft <= 0) { selectOption(null); return; }
    timeLeft--; updateTimerUI();
  },1000);
}
function updateTimerUI(){
  timerNum.textContent = timeLeft;
  const pct = Math.max(0, timeLeft)/40;
  const dash = CIRC * pct;
  timerArc.style.strokeDashoffset = (CIRC - dash).toFixed(2);
  timerArc.style.stroke = (timeLeft <= 5) ? "#b91c1c" : "#16a34a";
}

/* select */
function selectOption(idx){
  answers[current] = (typeof idx === "number") ? idx : null;
  current++;
  if (current >= getQuestions().length) finishTest();
  else { timeLeft = 40; loadQuestion(); startTimer(); }
}

/* compute analysis (hidden from student but saved into DB) */
function computeAnalysisForStorage(ans){
  function score(a){ if (a===null||a===undefined) return 0; if (a===0) return 2; if (a===1) return 1; if (a===2) return -1; if (a===3) return -2; return 0; }
  let emotional=0, discipline=0, curiosity=0, social=0, maths=0, unanswered=0;
  for (let i=0;i<=4;i++) emotional += score(ans[i]);
  discipline += score(ans[5])+score(ans[6])+score(ans[7])+score(ans[16]);
  curiosity += score(ans[8])+score(ans[9])+score(ans[14])+score(ans[15])+score(ans[19]);
  for (let i=10;i<=13;i++) social += score(ans[i]);
  maths += score(ans[17]);
  for (let i=0;i<20;i++) if (ans[i]===null||ans[i]===undefined) unanswered++;

  // normalization
  function normalize(v,min,max){ const vv=Math.max(min,Math.min(max,v)); return Math.round(((vv-min)/(max-min))*100); }
  const norm = {
    emotional: normalize(emotional,-10,10),
    discipline: normalize(discipline,-8,8),
    curiosity: normalize(curiosity,-10,10),
    social: normalize(social,-8,8),
    maths: normalize(maths,-2,2)
  };

  // persona simple mapping
  let persona = "Balanced Generalist";
  if (norm.curiosity >= 60 && norm.discipline >= 60) persona = "Adaptive Explorer";
  else if (norm.curiosity >= 60 && norm.discipline < 40) persona = "Creative Drifter";
  else if (norm.emotional >= 60 && norm.social >= 60) persona = "Empathetic Leader";
  else if (norm.social >= 60 && norm.discipline >= 60) persona = "Dependable Organizer";
  else if (norm.emotional < 40 && norm.discipline < 40) persona = "Sensitive Improviser";
  else if (norm.maths >= 70 && norm.curiosity >= 50) persona = "Analytical Thinker";

  // career
  const futureChoice = ans[18];
  let career = "Future preference unclear; expose the student to multiple domains.";
  if (futureChoice === 0) {
    if (norm.maths >= 60 && norm.discipline >= 50) career = "Technical/engineering path suits the student.";
    else career = "Interested in technical future, but strengthen maths fundamentals & consistency.";
  } else if (futureChoice === 1) {
    career = (norm.emotional>=60 && norm.social>=50) ? "Medical/healthcare aligns well." : "Interest exists; needs more resilience & routine.";
  } else if (futureChoice === 2) {
    career = (norm.social>=60) ? "Business/management suits." : "Oriented toward business; build confidence & exposure.";
  } else if (futureChoice === 3) {
    career = (norm.curiosity>=60) ? "Creative/non-traditional careers match curiosity." : "Creative track possible but needs exploration.";
  }

  // analysis bullet points
  const analysisPoints = [];
  analysisPoints.push(norm.emotional>=70 ? "Strong emotional resilience." : (norm.emotional>=40 ? "Emotionally balanced." : "Sensitive; benefits from reassurance."));
  analysisPoints.push(norm.discipline>=70 ? "Strong discipline." : (norm.discipline>=40 ? "Developing discipline." : "Struggles with consistency."));
  analysisPoints.push(norm.curiosity>=70 ? "Highly curious." : (norm.curiosity>=40 ? "Moderate curiosity." : "Low curiosity; needs safe environment."));
  analysisPoints.push(norm.social>=70 ? "Socially responsible & cooperative." : (norm.social>=40 ? "Balanced social responses." : "Prefers staying quiet; encourage small roles."));
  analysisPoints.push(career);

  if (unanswered >= 5) analysisPoints.push("Several questions left unanswered — may indicate hesitation or time pressure.");

  return {
    scores: norm,
    persona,
    careerRecommendation: career,
    analysisPoints
  };
}

/* finish: save to Firebase (student does not see analysis) */
async function finishTest(){
  clearInterval(timerInterval);
  showPage(pageReport);

  const nm = document.getElementById("name").value.trim();
  const cls = document.getElementById("class").value.trim();
  const sc = document.getElementById("school").value.trim();
  const dt = new Date().toISOString();

  rmeta.textContent = `Name: ${nm} | Class: ${cls} | School: ${sc} | Date: ${(new Date()).toLocaleDateString()}`;

  // show answers (student only)
  answersDiv.innerHTML = "";
  const qs = getQuestions();
  qs.forEach((q,i)=> {
    const idx = answers[i];
    const sel = (idx===null||idx===undefined) ? "Not answered" : q.options[idx];
    answersDiv.innerHTML += `<div class="rq">Q${q.id}. ${q.text.join(" ")}</div><div class="ra"><strong>Selected:</strong> ${sel}</div>`;
  });

  // compute analysis (hidden)
  const analysisObj = computeAnalysisForStorage(answers);

  // payload
  const payload = {
    name: nm,
    class: cls,
    school: sc,
    language: currentLanguage,
    timestamp: dt,
    answers: answers.map(a => (a===undefined)?null:a),
    scores: analysisObj.scores,
    persona: analysisObj.persona,
    careerRecommendation: analysisObj.careerRecommendation,
    analysisPoints: analysisObj.analysisPoints
  };

  // push to Firebase
  try {
    const newRef = db.ref('responses').push();
    await newRef.set(payload);
    info.textContent = "Responses recorded. A confidential report has been saved for counsellors.";
  } catch (err) {
    console.error("Firebase write error:", err);
    info.textContent = "Network error while saving responses. Please check connection or contact admin.";
  }
}

/* init */
document.addEventListener("DOMContentLoaded", ()=>{
  modalLangBtns.forEach(b=>b.classList.toggle("lang-active", b.dataset.lang===modalSelectedLanguage));
  // keyboard submit
  document.getElementById("name").addEventListener("keydown", e=>{ if (e.key==='Enter') startBtn.click(); });
  document.getElementById("school").addEventListener("keydown", e=>{ if (e.key==='Enter') startBtn.click(); });
});
</script>
</body>
</html>
